---
title: "Vignette of reading the fars_read function"
author: "JC"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette of reading the fars_read function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Vignette description

## The 'fars_read' function
The 'fars_read' function returns a table of the class 'data frame' when the input is a filename from the Fatality Analysis Reporting System (FARS) of the US National Highway Traffic Safety.

### Details 
When the file name exists, the fars_read function will be applied havng the following steps.
First, the file will be evaluated whether it is a csv file with comma as separator by the 'suppressMessages' function from the base package.
If the file is a csv, the file will be read in using the 'read_csv' function from the readr package and assigned as 'data'.
Then, this 'data' will be converted in a table having a 'data frame' class, using the 'tbl_df' function from the dplyr package.



```{r reading_farsFile}
fars_read <- function(filename) {
  if(!file.exists(filename))
    stop("file '", filename, "' does not exist")
  data <- suppressMessages({
    readr::read_csv(filename, progress = FALSE)
  })
  dplyr::tbl_df(data)
}

```


## The 'make_filename' function
The 'make_filename' function creates a filename, having a charactor vector containing a formatted combination
of text and the 'year' variable.

### Details
When the year is given, the year is converted into a integer by 'as.integer' from the base package, and
assigned as 'year'. Then, the 'year' variable will be used in the C function 'sprintf' from the base package.

```{r creating_farsFilename}
make_filename <- function(year) {
  year <- as.integer(year)
  createdFilename <- sprintf("accident_%d.csv.bz2", year)
  systemFilename <- system.file('extdata', createdFilename, package = 'farsReadTest')
  systemFilename
}

```


## The 'fars_read_years' function
The 'fars_read_years' function returns a list of each element of the 'year' variable which appears in the read-in file.

### Details
Within the 'fars_read_years' function, a 'lapply' function from the base package is used. The parameters for
the 'lapply' function are 'years' and the 'make_filename' function (defined above).
Within the 'lapply' function, the 'make_filename' function will be first applied on the 'year' variable and assigned
this as 'file'. Then, the 'tryCatch' function is called and evaluates its content, containing an expression and the function(e)
which implies an error. The expression is composed of:
    1) the 'fars_read' function of a file as 'dat'
    2) data manipulation of the 'dat' file: adding a new variable 'year' using the 'mutate' function of the dplyr package,
                                             followed by selecting the variables 'MONTH' and 'year' from the 'dat' file
When the year is valid, a list of valid years and months will be returned.

```{r reading_multipleYears}
fars_read_years <- function(years) {
  lapply(years, function(year) {
    file <- make_filename(year)
    tryCatch({
      dat <- fars_read(file)
      dplyr::mutate(dat, year = YEAR) %>%
        dplyr::select(MONTH, year)
    }, error = function(e) {
      warning("invalid year: ", year)
      return(NULL)
    })
  })
}

```
